<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAS Review{% if tenant_name %} - {{ tenant_name }}{% endif %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f8f8;
            min-height: 100vh;
            color: #222;
        }
        .header {
            background: #222;
            color: white;
            padding: 18px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: -0.3px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .tenant-name {
            background: rgba(255,255,255,0.1);
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.9em;
        }
        .header a {
            color: white;
            text-decoration: none;
            transition: opacity 0.2s ease;
        }
        .header a:hover {
            opacity: 0.8;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px;
        }
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            padding: 30px;
            margin-bottom: 24px;
            border: 1px solid #ededed;
        }
        .card h2 {
            color: #222;
            margin-bottom: 24px;
            font-size: 1.1em;
            font-weight: 600;
            letter-spacing: -0.2px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #222;
            font-size: 0.9em;
        }
        .form-group input {
            width: 100%;
            max-width: 200px;
            padding: 10px 14px;
            border: 1px solid #ededed;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.2s ease;
        }
        .form-group input:focus {
            border-color: #222;
            outline: none;
        }
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .btn {
            display: inline-block;
            padding: 12px 28px;
            font-size: 0.9em;
            font-weight: 500;
            text-decoration: none;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background: #FA5D29;
            color: white;
        }
        .btn-primary:hover {
            background: #e54d1c;
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .progress-section {
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f7931e, #f15a24);
            width: 0%;
            transition: width 0.3s ease;
        }
        .status-text {
            color: #666;
            font-size: 0.95em;
        }
        .results-section {
            display: none;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }
        .summary-card:hover {
            background: #e9ecef;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .summary-card.active {
            border-color: #FA5D29;
            background: #fff5f2;
        }
        .summary-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .summary-card .label {
            color: #666;
            font-size: 0.9em;
        }
        .summary-card.flagged .number {
            color: #dc3545;
        }
        .summary-card.flagged.active {
            border-color: #dc3545;
            background: #fff5f5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .severity-high {
            background: #ffcccc;
        }
        .severity-medium {
            background: #fff3cd;
        }
        .severity-low {
            background: #d4edda;
        }
        .severity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .severity-badge.high {
            background: #FA5D29;
            color: white;
        }
        .severity-badge.medium {
            background: #222;
            color: white;
        }
        .severity-badge.low {
            background: #AAEEC4;
            color: #222;
        }
        /* Group header styles */
        .group-header {
            transition: background 0.2s ease;
        }
        .group-header:hover {
            filter: brightness(0.97);
        }
        .group-header td {
            border-bottom: none !important;
        }
        .group-content {
            display: table-row-group;
        }
        .group-content tr:first-child td {
            border-top: none;
        }
        #group-controls {
            display: flex;
        }
        .comment-cell {
            font-size: 13px;
            color: #444;
            line-height: 1.5;
        }
        .comment-cell ul {
            margin: 0;
            padding-left: 16px;
        }
        .comment-cell li {
            margin-bottom: 3px;
        }
        #flagged-table-container {
            overflow-x: auto;
            max-width: 100%;
            margin-bottom: 20px;
        }
        .flagged-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .flagged-table th {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1;
            padding: 16px 12px;
            font-weight: 700;
            color: #222;
            text-align: left;
            border-bottom: 1px solid #ededed;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .flagged-table td {
            vertical-align: top;
            padding: 16px 12px;
            border-bottom: 2px solid #ededed;
            color: #222;
        }
        .flagged-table tbody tr {
            transition: background-color 0.15s ease;
        }
        .flagged-table tbody tr:hover {
            background-color: #fff8f5;
        }
        .flagged-table small {
            color: #888;
        }
        .journal-cell {
            padding: 8px !important;
            position: relative;
            vertical-align: top;
            width: 280px;
            min-width: 280px;
            max-width: 280px;
        }
        .delete-row-btn {
            background: transparent;
            color: #999;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            transition: all 0.2s ease;
        }
        .delete-row-btn:hover {
            background: #fef2f2;
            color: #FA5D29;
        }
        .journal-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        .journal-btn:hover {
            background: #218838;
        }
        .journal-btn.review-btn {
            background: #6c757d;
        }
        .journal-btn.review-btn:hover {
            background: #5a6268;
        }
        .journal-popover {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 1000;
            min-width: 350px;
            max-width: 450px;
        }
        .journal-popover.show {
            display: block;
        }
        .journal-popover-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .journal-popover-header h4 {
            margin: 0;
            font-size: 14px;
            color: #333;
        }
        .journal-popover-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            line-height: 1;
        }
        .journal-popover-close:hover {
            color: #333;
        }
        .journal-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
            background: #fff;
            border: 1px solid #ededed;
            border-radius: 6px;
            overflow: hidden;
            table-layout: fixed;
        }
        .journal-table th {
            background: #fafafa;
            padding: 10px 12px;
            font-weight: 500;
            text-align: left;
            border-bottom: 1px solid #ededed;
            color: #666;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .journal-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f5f5f5;
            vertical-align: middle;
            color: #222;
        }
        .journal-table tr:last-child td {
            border-bottom: none;
        }
        .journal-table td:nth-child(2),
        .journal-table td:nth-child(3) {
            text-align: right;
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 600;
            color: #16a34a;
        }
        .journal-table td:nth-child(3) {
            color: #FA5D29;
        }
        .no-issues {
            text-align: center;
            padding: 40px;
            color: #28a745;
        }
        .no-issues .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .download-section {
            margin-top: 20px;
            text-align: right;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #f7931e;
            background: #f8f9ff;
        }
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .upload-area p {
            color: #666;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä BAS Reviewer</h1>
        <div class="header-right">
            {% if logged_in %}
            <span class="tenant-name">{{ tenant_name }}</span>
            {% endif %}
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('auth.logout') }}">Logout</a>
        </div>
    </div>

    <div class="container">
        {% if logged_in %}
        <!-- Xero Review Section - shown when connected to Xero -->
        <div class="card" id="xero-review-card">
            <h2>Review Transactions from Xero</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Select the date range to review transactions from {{ tenant_name }}.
            </p>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Start Date</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="start-date" placeholder="dd/mm/yyyy" style="padding: 10px; border: 2px solid #e1e1e1; border-radius: 8px 0 0 8px; font-size: 1em; width: 120px;">
                        <button type="button" onclick="document.getElementById('start-date-picker').showPicker()" style="padding: 10px 12px; border: 2px solid #e1e1e1; border-left: none; border-radius: 0 8px 8px 0; background: #f8f9fa; cursor: pointer; font-size: 1em;">üìÖ</button>
                        <input type="date" id="start-date-picker" style="position: absolute; opacity: 0; pointer-events: none;" onchange="syncDateFromPicker('start-date', this.value)">
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">End Date</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="end-date" placeholder="dd/mm/yyyy" style="padding: 10px; border: 2px solid #e1e1e1; border-radius: 8px 0 0 8px; font-size: 1em; width: 120px;">
                        <button type="button" onclick="document.getElementById('end-date-picker').showPicker()" style="padding: 10px 12px; border: 2px solid #e1e1e1; border-left: none; border-radius: 0 8px 8px 0; background: #f8f9fa; cursor: pointer; font-size: 1em;">üìÖ</button>
                        <input type="date" id="end-date-picker" style="position: absolute; opacity: 0; pointer-events: none;" onchange="syncDateFromPicker('end-date', this.value)">
                    </div>
                </div>
            </div>

            <!-- Review Mode Selection -->
            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Review Mode</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #13B5EA; border-radius: 8px; background: white;">
                        <input type="radio" name="review-mode" value="quick" checked style="width: 18px; height: 18px;">
                        <div>
                            <div style="font-weight: 600; color: #333;">Quick Review</div>
                            <div style="font-size: 0.85em; color: #666;">Standard review of selected period</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #f15a24; border-radius: 8px; background: white;">
                        <input type="radio" name="review-mode" value="deep" style="width: 18px; height: 18px;">
                        <div>
                            <div style="font-weight: 600; color: #333;">Deep Scan</div>
                            <div style="font-size: 0.85em; color: #666;">Learn patterns from 12 months history first</div>
                        </div>
                    </label>
                </div>
                <p id="deep-scan-note" style="display: none; margin-top: 10px; font-size: 0.9em; color: #f15a24;">
                    Deep scan will analyze 12 months of history to detect allocation patterns. This takes longer but reduces false positives.
                </p>
            </div>

            <button class="btn btn-primary" id="xero-review-btn" onclick="runXeroReview()" style="background: #13B5EA;">
                Start Review
            </button>
        </div>
        {% else %}
        <!-- File Upload Section - shown when NOT connected to Xero -->
        <div class="card" id="upload-card">
            <h2>Upload General Ledger Detail Report</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Export the "General Ledger Detail" report from Xero (Reports ‚Üí All Reports ‚Üí General Ledger Detail) as an Excel file, then upload it here.
            </p>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìÅ</div>
                <p>Drag and drop your Excel file here, or click to browse</p>
                <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
            </div>
            <div id="file-name" style="margin-top: 15px; color: #f7931e; display: none;"></div>
            <button class="btn btn-primary" id="upload-btn" onclick="uploadFile()" style="margin-top: 20px;" disabled>
                Review Uploaded File
            </button>
        </div>
        {% endif %}

        <!-- Progress Section -->
        <div class="card progress-section" id="progress-section">
            <h2>Review Progress</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p class="status-text" id="status-text">Connecting to Xero...</p>
        </div>

        <!-- Results Section -->
        <div class="card results-section" id="results-section">
            <h2>Review Results</h2>

            <div class="summary-cards">
                <div class="summary-card" id="total-card" onclick="showAllTransactions()">
                    <div class="number" id="total-count">0</div>
                    <div class="label">Total Transactions</div>
                </div>
                <div class="summary-card flagged active" id="flagged-card" onclick="showFlaggedItems()">
                    <div class="number" id="flagged-count">0</div>
                    <div class="label">Flagged Items</div>
                </div>
            </div>

            <div id="flagged-table-container">
                <!-- Table will be inserted here -->
            </div>

            <div class="download-section" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" id="download-btn" onclick="downloadReport()" style="display:none;">
                    Download Excel Report
                </button>
                <button class="btn" id="push-all-btn" onclick="pushAllJournalsToXero()" style="display:none; background:#13B5EA; color:white;">
                    Push All Journals to Xero (Draft)
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let reviewResults = null;  // Store results for download
        let allTransactionsData = [];  // Store all transactions for toggle view
        let currentView = 'flagged';  // Track current view: 'flagged' or 'all'

        // XSS Protection - escape HTML entities in user-controlled data
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Helper function to format date as dd/mm/yyyy
        function formatDateAU(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Helper function to parse dd/mm/yyyy to Date object
        function parseDateAU(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }

        // Helper function to convert dd/mm/yyyy to yyyy-mm-dd for API
        function toISODate(dateStr) {
            const date = parseDateAU(dateStr);
            if (!date) return null;
            return date.toISOString().split('T')[0];
        }

        // Sync date from native picker to text input (convert yyyy-mm-dd to dd/mm/yyyy)
        function syncDateFromPicker(textInputId, isoDate) {
            if (!isoDate) return;
            const parts = isoDate.split('-');
            if (parts.length !== 3) return;
            const formatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
            document.getElementById(textInputId).value = formatted;
        }

        // Set default dates for Xero review (PREVIOUS quarter)
        // Australian BAS quarters: Jul-Sep, Oct-Dec, Jan-Mar, Apr-Jun
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        if (startDateInput && endDateInput) {
            const today = new Date();
            const month = today.getMonth(); // 0-11
            const year = today.getFullYear();

            // Determine current quarter and calculate previous quarter
            // Q1: Jul-Sep (months 6,7,8), Q2: Oct-Dec (9,10,11), Q3: Jan-Mar (0,1,2), Q4: Apr-Jun (3,4,5)
            let prevQStart, prevQEnd;

            if (month >= 0 && month <= 2) {
                // Current is Jan-Mar, previous is Oct-Dec of previous year
                prevQStart = new Date(year - 1, 9, 1);  // Oct 1
                prevQEnd = new Date(year - 1, 11, 31); // Dec 31
            } else if (month >= 3 && month <= 5) {
                // Current is Apr-Jun, previous is Jan-Mar
                prevQStart = new Date(year, 0, 1);     // Jan 1
                prevQEnd = new Date(year, 2, 31);      // Mar 31
            } else if (month >= 6 && month <= 8) {
                // Current is Jul-Sep, previous is Apr-Jun
                prevQStart = new Date(year, 3, 1);     // Apr 1
                prevQEnd = new Date(year, 5, 30);      // Jun 30
            } else {
                // Current is Oct-Dec, previous is Jul-Sep
                prevQStart = new Date(year, 6, 1);     // Jul 1
                prevQEnd = new Date(year, 8, 30);      // Sep 30
            }

            startDateInput.value = formatDateAU(prevQStart);
            endDateInput.value = formatDateAU(prevQEnd);
        }

        // Review mode toggle
        document.querySelectorAll('input[name="review-mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const deepScanNote = document.getElementById('deep-scan-note');
                const reviewBtn = document.getElementById('xero-review-btn');
                if (this.value === 'deep') {
                    deepScanNote.style.display = 'block';
                    reviewBtn.textContent = 'Start Deep Scan';
                    reviewBtn.style.background = '#f15a24';
                } else {
                    deepScanNote.style.display = 'none';
                    reviewBtn.textContent = 'Start Review';
                    reviewBtn.style.background = '#13B5EA';
                }
            });
        });

        // Xero review function
        async function runXeroReview() {
            const startDateRaw = document.getElementById('start-date').value;
            const endDateRaw = document.getElementById('end-date').value;
            const reviewMode = document.querySelector('input[name="review-mode"]:checked').value;

            if (!startDateRaw || !endDateRaw) {
                alert('Please enter both start and end dates');
                return;
            }

            // Convert dd/mm/yyyy to yyyy-mm-dd for API
            const startDate = toISODate(startDateRaw);
            const endDate = toISODate(endDateRaw);

            if (!startDate || !endDate) {
                alert('Please enter dates in dd/mm/yyyy format');
                return;
            }

            // Show progress
            document.getElementById('xero-review-btn').disabled = true;
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            let progress = 0;
            const progressFill = document.getElementById('progress-fill');
            const statusText = document.getElementById('status-text');

            // Progress stages with estimated timing
            const stages = reviewMode === 'deep' ? [
                { pct: 10, msg: 'Scanning 12 months of history to learn patterns...' },
                { pct: 30, msg: 'Analyzing historical transaction patterns...' },
                { pct: 50, msg: 'Fetching transactions for selected period...' },
                { pct: 65, msg: 'Running BAS compliance checks...' },
                { pct: 80, msg: 'AI reviewing flagged transactions...' },
                { pct: 90, msg: 'Finalizing review (this may take a minute)...' }
            ] : [
                { pct: 15, msg: 'Fetching transactions from Xero...' },
                { pct: 40, msg: 'Running BAS compliance checks...' },
                { pct: 65, msg: 'AI reviewing flagged transactions...' },
                { pct: 85, msg: 'Finalizing review...' }
            ];

            let stageIndex = 0;
            statusText.textContent = stages[0].msg;

            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * (reviewMode === 'deep' ? 2 : 5);
                    progress = Math.min(progress, 90);
                    progressFill.style.width = progress + '%';

                    // Update status message based on progress
                    while (stageIndex < stages.length - 1 && progress >= stages[stageIndex + 1].pct) {
                        stageIndex++;
                        statusText.textContent = stages[stageIndex].msg;
                    }
                }
            }, 800);

            try {
                const response = await fetch('/api/run-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        review_mode: reviewMode
                    })
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                // Check if response is OK before parsing JSON
                if (!response.ok) {
                    const text = await response.text();
                    // Check if it's HTML (server error page)
                    if (text.trim().startsWith('<')) {
                        throw new Error(`Server error (${response.status}). The review may have timed out. Try a shorter date range.`);
                    }
                    // Try to parse as JSON error
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    } catch (parseErr) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                }

                const data = await response.json();

                if (data.error) {
                    let errorMsg = 'Error: ' + data.error;
                    if (data.debug && Array.isArray(data.debug)) {
                        errorMsg += '\n\nDebug Info:\n' + data.debug.join('\n');
                    }
                    statusText.innerHTML = '<pre style="text-align: left; white-space: pre-wrap; font-size: 12px;">' + escapeHtml(errorMsg) + '</pre>';
                    document.getElementById('xero-review-btn').disabled = false;
                    return;
                }

                reviewResults = data;
                displayResults(data);
                document.getElementById('xero-review-btn').disabled = false;

            } catch (error) {
                clearInterval(progressInterval);
                statusText.textContent = 'Error: ' + error.message;
                document.getElementById('xero-review-btn').disabled = false;
            }
        }

        // File upload handling - only if upload elements exist
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileNameDiv = document.getElementById('file-name');
        const uploadBtn = document.getElementById('upload-btn');

        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('Please select an Excel file (.xlsx or .xls)');
                return;
            }
            selectedFile = file;
            fileNameDiv.textContent = 'Selected: ' + file.name;
            fileNameDiv.style.display = 'block';
            uploadBtn.disabled = false;

            // Change folder icon to green checkmark when file is selected
            const uploadIcon = document.querySelector('.upload-icon');
            if (uploadIcon) {
                uploadIcon.textContent = '‚úÖ';
                uploadIcon.style.color = '#16a34a';
            }
        }

        async function uploadFile() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            // Show progress
            uploadBtn.disabled = true;
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            let progress = 0;
            const progressFill = document.getElementById('progress-fill');
            const statusText = document.getElementById('status-text');

            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    progressFill.style.width = Math.min(progress, 90) + '%';
                }
            }, 300);

            statusText.textContent = 'Uploading and parsing file...';

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const response = await fetch('/api/upload-review', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                statusText.textContent = 'Review complete!';

                // Check for HTML error response before parsing JSON
                if (!response.ok) {
                    const text = await response.text();
                    if (text.trim().startsWith('<')) {
                        throw new Error(`Server error (${response.status}). The review may have timed out. Try a smaller file.`);
                    }
                    try {
                        const errorData = JSON.parse(text);
                        throw new Error(errorData.error || `Server error: ${response.status}`);
                    } catch (parseErr) {
                        if (parseErr.message.includes('Server error')) throw parseErr;
                        throw new Error(`Server error: ${response.status}`);
                    }
                }

                const data = await response.json();

                if (response.ok) {
                    displayResults(data, true);  // true = upload mode (no Push to Xero)
                } else {
                    let errorMsg = data.error || 'Review failed (no error details)';
                    if (data.hint) errorMsg += '\n\nHint: ' + data.hint;
                    if (data.first_rows) errorMsg += '\n\nFirst rows:\n' + data.first_rows;
                    if (data.trace) {
                        console.error('Server Error Trace:', data.trace);
                        errorMsg += '\n\n(Check browser console for details)';
                    }
                    console.error('Review error response:', data);
                    alert('Error: ' + errorMsg);
                    document.getElementById('progress-section').style.display = 'none';
                }
            } catch (error) {
                clearInterval(progressInterval);
                document.getElementById('progress-section').style.display = 'none';
                alert('Error: ' + error.message);
            }

            uploadBtn.disabled = false;
        }

        // Format date to dd/mm/yyyy (accepts Date object or yyyy-mm-dd string)
        function formatDateAU(dateInput) {
            if (!dateInput) return '';

            // Handle Date object
            if (dateInput instanceof Date) {
                const day = String(dateInput.getDate()).padStart(2, '0');
                const month = String(dateInput.getMonth() + 1).padStart(2, '0');
                const year = dateInput.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Handle yyyy-mm-dd string
            if (typeof dateInput === 'string') {
                const parts = dateInput.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
            }
            return String(dateInput);
        }

        // Store flagged items globally for filtering
        let allFlaggedItems = [];
        let isUploadMode = false;  // Track if results are from file upload
        let groupedView = true;  // Default to grouped view

        // Issue type definitions with display names and colors
        const ISSUE_TYPES = {
            'export_gst': { name: 'Export GST Errors', color: '#e74c3c', icon: 'üåè' },
            'entertainment': { name: 'Entertainment Expenses', color: '#9b59b6', icon: 'üéâ' },
            'wages': { name: 'Wages/Salary GST', color: '#3498db', icon: 'üíº' },
            'government_charges': { name: 'Government Charges', color: '#1abc9c', icon: 'üèõÔ∏è' },
            'grants': { name: 'Grants & Sponsorship', color: '#f39c12', icon: 'üí∞' },
            'residential': { name: 'Residential Property', color: '#e67e22', icon: 'üè†' },
            'input_taxed': { name: 'Input Taxed Supplies', color: '#34495e', icon: 'üè¶' },
            'insurance': { name: 'Insurance GST', color: '#16a085', icon: 'üõ°Ô∏è' },
            'travel': { name: 'Travel GST', color: '#2980b9', icon: '‚úàÔ∏è' },
            'fines': { name: 'Fines & Penalties', color: '#c0392b', icon: '‚ö†Ô∏è' },
            'donations': { name: 'Donations', color: '#27ae60', icon: '‚ù§Ô∏è' },
            'asset': { name: 'Asset Capitalization', color: '#8e44ad', icon: 'üèóÔ∏è' },
            'drawings': { name: 'Drawings/Loan', color: '#d35400', icon: 'üë§' },
            'personal': { name: 'Personal Expenses', color: '#c0392b', icon: 'üö´' },
            'missing_gst': { name: 'Missing GST', color: '#e74c3c', icon: '‚ùå' },
            'account_coding': { name: 'Account Coding', color: '#7f8c8d', icon: 'üìù' },
            'general_expenses': { name: 'General/Sundry Expenses', color: '#95a5a6', icon: 'üìã' },
            'other': { name: 'Other Issues', color: '#bdc3c7', icon: '‚ùì' }
        };

        // Determine issue type from transaction flags
        function getIssueType(item) {
            if (item.export_gst_error) return 'export_gst';
            if (item.client_entertainment_gst || item.staff_entertainment_gst || item.alcohol_gst_error) return 'entertainment';
            if (item.wages_gst_error || item.allowance_gst_error) return 'wages';
            if (item.government_charges_gst) return 'government_charges';
            if (item.grants_sponsorship_gst) return 'grants';
            if (item.residential_premises_gst) return 'residential';
            if (item.input_taxed_gst_error) return 'input_taxed';
            if (item.insurance_gst_error || item.life_insurance_personal) return 'insurance';
            if (item.travel_gst) return 'travel';
            if (item.fines_penalties_gst) return 'fines';
            if (item.donations_gst) return 'donations';
            if (item.asset_capitalization_error || item.computer_equipment_expense) return 'asset';
            if (item.drawings_loan_error) return 'drawings';
            if (item.personal_in_business_account) return 'personal';
            if (item.missing_gst_error) return 'missing_gst';
            if (item.account_coding_suspicious) return 'account_coding';
            if (item.general_expenses) return 'general_expenses';
            return 'other';
        }

        // Group items by issue type
        function groupByIssueType(items) {
            const groups = {};
            items.forEach(item => {
                const issueType = getIssueType(item);
                if (!groups[issueType]) {
                    groups[issueType] = [];
                }
                groups[issueType].push(item);
            });
            return groups;
        }

        // Toggle grouped view
        function toggleGroupedView() {
            groupedView = !groupedView;
            const btn = document.getElementById('toggle-group-btn');
            btn.textContent = groupedView ? 'List View' : 'Group by Issue';
            btn.style.background = groupedView ? '#FA5D29' : '#6c757d';
            renderFlaggedItems(allFlaggedItems);
        }

        // Toggle group expand/collapse
        function toggleGroup(groupId) {
            const content = document.getElementById('group-content-' + groupId);
            const icon = document.getElementById('group-icon-' + groupId);
            if (content.style.display === 'none') {
                content.style.display = 'table-row-group';
                icon.textContent = '‚ñº';
            } else {
                content.style.display = 'none';
                icon.textContent = '‚ñ∂';
            }
        }

        // Expand all groups
        function expandAllGroups() {
            document.querySelectorAll('[id^="group-content-"]').forEach(el => {
                el.style.display = 'table-row-group';
            });
            document.querySelectorAll('[id^="group-icon-"]').forEach(el => {
                el.textContent = '‚ñº';
            });
        }

        // Collapse all groups
        function collapseAllGroups() {
            document.querySelectorAll('[id^="group-content-"]').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('[id^="group-icon-"]').forEach(el => {
                el.textContent = '‚ñ∂';
            });
        }

        function displayResults(data, uploadMode = false) {
            isUploadMode = uploadMode;  // Store for later use
            // Store results for download
            reviewResults = data;

            // Store all transactions for toggle view
            if (data.all_transactions) {
                allTransactionsData = data.all_transactions;
            }

            // Reset to flagged view when displaying new results
            currentView = 'flagged';
            document.getElementById('flagged-card').classList.add('active');
            document.getElementById('total-card').classList.remove('active');

            // Hide progress, show results
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';

            // Update counts
            document.getElementById('total-count').textContent = data.total_transactions || 0;
            document.getElementById('flagged-count').textContent = data.flagged_count || 0;

            // Scroll to results
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });

            const container = document.getElementById('flagged-table-container');

            const flaggedCount = data.flagged_count || 0;
            allFlaggedItems = data.flagged_items || [];
            const flaggedItems = allFlaggedItems;

            if (flaggedCount === 0 || flaggedItems.length === 0) {
                container.innerHTML = `
                    <div class="no-issues">
                        <div class="icon">‚úÖ</div>
                        <h3>No Issues Found</h3>
                        <p>All ${data.total_transactions || 0} transactions appear to be correctly recorded.</p>
                    </div>
                `;
                document.getElementById('download-btn').style.display = 'none';
            } else {
                let tableHtml = `
                    <div class="filter-controls" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <button id="toggle-group-btn" onclick="toggleGroupedView()" style="padding: 8px 16px; background: #FA5D29; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">List View</button>
                        <div style="border-left: 1px solid #ddd; height: 24px; margin: 0 5px;"></div>
                        <select id="filter-issue-type" onchange="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">All Issue Types</option>
                            ${Object.entries(ISSUE_TYPES).map(([key, val]) => `<option value="${key}">${val.icon} ${val.name}</option>`).join('')}
                        </select>
                        <input type="text" id="filter-description" placeholder="Description..." oninput="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 150px;">
                        <input type="text" id="filter-account" placeholder="Account..." oninput="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 120px;">
                        <select id="filter-severity" onchange="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">All Severities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <select id="filter-source" onchange="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">All Sources</option>
                            <option value="Bill">Bill</option>
                            <option value="Spend Money">Spend Money</option>
                            <option value="Receive Money">Receive Money</option>
                            <option value="Manual Journal">Manual Journal</option>
                        </select>
                        <button onclick="clearFilters()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Clear</button>
                        <span id="filter-count" style="margin-left: auto; font-size: 14px; color: #666;"></span>
                        <div id="group-controls" style="display: flex; gap: 5px;">
                            <button onclick="expandAllGroups()" style="padding: 4px 8px; background: #eee; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px;">Expand All</button>
                            <button onclick="collapseAllGroups()" style="padding: 4px 8px; background: #eee; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; font-size: 12px;">Collapse All</button>
                        </div>
                    </div>
                    <div id="table-scroll-wrapper" style="overflow-x: auto; width: 100%;">
                    <table class="flagged-table" id="results-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th style="width: 35px;">Row</th>
                                <th style="width: 60px;">Severity</th>
                                <th style="width: 75px;">Date</th>
                                <th style="width: 100px;">Account</th>
                                <th style="width: 140px;">Description</th>
                                <th style="width: 70px;">Gross</th>
                                <th style="width: 55px;">GST</th>
                                <th style="width: 70px;">Net</th>
                                <th style="width: 90px;">GST Rate</th>
                                <th style="width: 60px;">Source</th>
                                <th style="width: 180px;">Comments</th>
                                <th style="width: 280px;">Suggested Journal</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                `;

                // Helper function to render a single item row
                function renderItemRow(item, uploadMode) {
                    const desc = escapeHtml(item.description);
                    const comments = escapeHtml(item.comments || '');
                    const commentParts = comments.split(' | ').filter(c => c.trim());
                    let formattedComments = commentParts.length > 1
                        ? '<ul style="margin:0; padding-left:18px;">' + commentParts.map(c => '<li>' + c + '</li>').join('') + '</ul>'
                        : comments;

                    // Add ATO references below comments
                    if (item.ato_references && item.ato_references.length > 0) {
                        formattedComments += '<div class="ato-refs" style="margin-top:8px; padding-top:6px; border-top:1px dashed #ddd; font-size:11px;">';
                        formattedComments += '<span style="color:#666; font-weight:500;">üìö ATO References:</span><br>';
                        item.ato_references.forEach(ref => {
                            formattedComments += `<a href="${escapeHtml(ref.url)}" target="_blank" rel="noopener" style="color:#0052CC; text-decoration:none; display:inline-block; margin:2px 0;">‚Üí ${escapeHtml(ref.title)}</a><br>`;
                        });
                        formattedComments += '</div>';
                    }

                    let journalHtml = '';
                    if (item.correcting_journal && item.correcting_journal.entries && item.correcting_journal.entries.length > 0) {
                        journalHtml = '<table class="journal-table"><thead><tr><th>Acc</th><th>DR</th><th>CR</th><th>Tax</th></tr></thead><tbody>';
                        item.correcting_journal.entries.forEach(entry => {
                            const dr = entry.debit > 0 ? '$' + parseFloat(entry.debit).toLocaleString('en-AU', {minimumFractionDigits: 2}) : '';
                            const cr = entry.credit > 0 ? '$' + parseFloat(entry.credit).toLocaleString('en-AU', {minimumFractionDigits: 2}) : '';
                            journalHtml += '<tr>';
                            journalHtml += '<td><strong>' + escapeHtml(entry.account_code || '') + '</strong><br><small>' + escapeHtml(entry.account_name || '') + '</small></td>';
                            journalHtml += '<td style="text-align:right;">' + dr + '</td>';
                            journalHtml += '<td style="text-align:right;">' + cr + '</td>';
                            journalHtml += '<td><small>' + escapeHtml(entry.tax_code || '') + '</small></td>';
                            journalHtml += '</tr>';
                        });
                        journalHtml += '</tbody></table>';
                        const isRevenueAcct = (accountCode, accountName) => {
                            const name = (accountName || '').toLowerCase();
                            return name.includes('sales') || name.includes('income') || name.includes('revenue') ||
                                name.includes('fees earned') || name.includes('interest received');
                        };
                        const mapTaxCode = (taxCode, accountCode, accountName) => {
                            const isRevenue = isRevenueAcct(accountCode, accountName);
                            if (taxCode === 'GST on Expenses' || taxCode === 'GST on Income') return isRevenue ? 'OUTPUT' : 'INPUT';
                            if (taxCode === 'GST Free' || taxCode === 'GST Free Expenses' || taxCode === 'GST Free Income') return isRevenue ? 'EXEMPTOUTPUT' : 'EXEMPTEXPENSES';
                            if (taxCode === 'BAS Excluded' || taxCode === 'NONE') return 'BASEXCLUDED';
                            if (taxCode === 'Input Taxed') return 'INPUTTAXED';
                            return 'BASEXCLUDED';
                        };
                        const journalData = {
                            narration: item.correcting_journal.narration || `BAS Correction: ${item.description}`,
                            date: item.date,
                            entries: item.correcting_journal.entries.map(e => ({
                                AccountCode: e.account_code,
                                Description: e.description || e.account_name,
                                LineAmount: e.debit > 0 ? e.debit : -e.credit,
                                TaxType: mapTaxCode(e.tax_code, e.account_code, e.account_name)
                            }))
                        };
                        const journalDataStr = btoa(JSON.stringify(journalData));
                        if (!uploadMode) {
                            journalHtml += `<button class="btn-push-xero" onclick="pushJournalToXero('${journalDataStr}', this)" style="margin-left:5px; padding:6px 10px; font-size:12px; background:#13B5EA; color:white; border:none; border-radius:4px; cursor:pointer;">Push to Xero</button>`;
                        }
                    } else {
                        let reviewMsg = 'Review';
                        if (item.account_coding_suspicious || (item.comments && item.comments.toLowerCase().includes('account'))) reviewMsg = 'Review account';
                        else if (item.missing_gst_error || item.input_taxed_gst_error || (item.comments && item.comments.toLowerCase().includes('gst'))) reviewMsg = 'Review GST';
                        else if (item.comments && item.comments.toLowerCase().includes('capitaliz')) reviewMsg = 'Review asset';
                        journalHtml = `<em style="color:#666;">${reviewMsg}</em>`;
                    }

                    const safeSeverity = ['low', 'medium', 'high'].includes(item.severity) ? item.severity : 'medium';
                    const issueType = getIssueType(item);

                    return `
                        <tr class="severity-${safeSeverity}"
                            data-description="${escapeHtml(item.description || '').toLowerCase()}"
                            data-account="${escapeHtml(item.account || '').toLowerCase()} ${escapeHtml(item.account_code || '').toLowerCase()}"
                            data-severity="${safeSeverity}"
                            data-source="${escapeHtml(item.source || '').toLowerCase()}"
                            data-issue-type="${issueType}"
                            data-row-number="${escapeHtml(item.row_number)}">
                            <td><button class="delete-row-btn" onclick="deleteRow(this, ${item.row_number})" title="Remove from report">√ó</button></td>
                            <td>${escapeHtml(item.row_number)}</td>
                            <td><span class="severity-badge ${safeSeverity}">${safeSeverity.toUpperCase()}</span></td>
                            <td>${formatDateAU(item.date)}</td>
                            <td>${escapeHtml(item.account || '')} <small style="color:#666;">(${escapeHtml(item.account_code || '')})</small></td>
                            <td>${desc}</td>
                            <td style="text-align:right;">$${parseFloat(item.gross || 0).toLocaleString('en-AU', {minimumFractionDigits: 2})}</td>
                            <td style="text-align:right;">$${parseFloat(item.gst || 0).toLocaleString('en-AU', {minimumFractionDigits: 2})}</td>
                            <td style="text-align:right;">$${parseFloat(item.net || 0).toLocaleString('en-AU', {minimumFractionDigits: 2})}</td>
                            <td><small style="font-size: 11px;">${escapeHtml(item.gst_rate_name || '-')}</small></td>
                            <td><small>${escapeHtml(item.source || '-')}</small>${item.xero_url ? `<br><a href="${escapeHtml(item.xero_url)}" target="_blank" style="font-size: 11px; color: #13B5EA;">View</a>` : ''}</td>
                            <td class="comment-cell">${formattedComments}</td>
                            <td class="journal-cell">${journalHtml}</td>
                        </tr>
                    `;
                }

                // Render items - grouped or flat
                if (groupedView) {
                    const groups = groupByIssueType(flaggedItems);
                    // Sort groups by count (most items first)
                    const sortedGroups = Object.entries(groups).sort((a, b) => b[1].length - a[1].length);

                    sortedGroups.forEach(([issueType, items]) => {
                        const issueInfo = ISSUE_TYPES[issueType] || ISSUE_TYPES['other'];
                        tableHtml += `
                            <tr class="group-header" onclick="toggleGroup('${issueType}')" style="cursor: pointer; background: linear-gradient(135deg, ${issueInfo.color}15, ${issueInfo.color}08);">
                                <td colspan="13" style="padding: 12px 15px; border-left: 4px solid ${issueInfo.color};">
                                    <span id="group-icon-${issueType}" style="margin-right: 8px; font-size: 12px;">‚ñº</span>
                                    <span style="font-size: 16px; margin-right: 8px;">${issueInfo.icon}</span>
                                    <strong style="font-size: 14px; color: #222;">${issueInfo.name}</strong>
                                    <span style="margin-left: 10px; background: ${issueInfo.color}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: 600;">${items.length}</span>
                                </td>
                            </tr>
                        `;
                        tableHtml += `<tbody id="group-content-${issueType}" class="group-content">`;
                        items.forEach(item => {
                            tableHtml += renderItemRow(item, uploadMode);
                        });
                        tableHtml += `</tbody>`;
                    });
                } else {
                    flaggedItems.forEach(item => {
                        tableHtml += renderItemRow(item, uploadMode);
                    });
                }

                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
                document.getElementById('download-btn').style.display = 'inline-block';
                // Show Push All button only if there are flagged items with journals AND not in upload mode
                const hasJournals = data.flagged_items && data.flagged_items.some(item =>
                    item.correcting_journal && item.correcting_journal.entries && item.correcting_journal.entries.length > 0
                );
                if (hasJournals && !uploadMode) {
                    document.getElementById('push-all-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('push-all-btn').style.display = 'none';
                }
            }

            // Always show download button (even if no issues, user might want the report)
            document.getElementById('download-btn').style.display = 'inline-block';
        }

        async function downloadReport() {
            if (!reviewResults) {
                alert('No review results to download');
                return;
            }

            try {
                const response = await fetch('/download-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reviewResults)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `BAS_Review_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const error = await response.json();
                    alert('Download failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Download error: ' + error.message);
            }
        }

        async function pushJournalToXero(journalDataBase64, buttonElement) {
            try {
                // Decode the journal data
                const journalData = JSON.parse(atob(journalDataBase64));

                // Disable the button and show loading state
                buttonElement.disabled = true;
                buttonElement.textContent = 'Pushing...';
                buttonElement.style.background = '#999';

                const response = await fetch('/api/push-journal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(journalData)
                });

                const result = await response.json();

                if (result.success) {
                    buttonElement.textContent = '‚úì Pushed to Xero';
                    buttonElement.style.background = '#28a745';
                    buttonElement.style.cursor = 'default';
                    // Show success message
                    const msg = result.journal_number
                        ? `Draft journal #${result.journal_number} created in Xero!`
                        : 'Draft journal created in Xero!';
                    alert(msg);
                } else {
                    buttonElement.textContent = 'Push to Xero (Draft)';
                    buttonElement.style.background = '#13B5EA';
                    buttonElement.disabled = false;
                    alert('Failed to push journal: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                buttonElement.textContent = 'Push to Xero (Draft)';
                buttonElement.style.background = '#13B5EA';
                buttonElement.disabled = false;
                alert('Error pushing journal: ' + error.message);
            }
        }

        // Delete row function - removes from table and report data
        function deleteRow(button, rowNumber) {
            // Remove from reviewResults so it won't be in the downloaded report
            if (reviewResults && reviewResults.flagged_items) {
                reviewResults.flagged_items = reviewResults.flagged_items.filter(item => item.row_number !== rowNumber);
                reviewResults.flagged_count = reviewResults.flagged_items.length;

                // Update the flagged count display
                document.getElementById('flagged-count').textContent = reviewResults.flagged_count;
            }

            // Remove the row from the table
            const row = button.closest('tr');
            if (row) {
                row.remove();
            }

            // Update filter count if filters are active
            applyFilters();
        }

        // Filter functions
        function applyFilters() {
            const descFilter = (document.getElementById('filter-description')?.value || '').toLowerCase();
            const accountFilter = (document.getElementById('filter-account')?.value || '').toLowerCase();
            const severityFilter = document.getElementById('filter-severity')?.value || '';
            const sourceFilter = (document.getElementById('filter-source')?.value || '').toLowerCase();
            const issueTypeFilter = document.getElementById('filter-issue-type')?.value || '';

            // Preserve horizontal scroll position of the table scroll wrapper
            const scrollWrapper = document.getElementById('table-scroll-wrapper');
            const scrollLeft = scrollWrapper ? scrollWrapper.scrollLeft : 0;

            // Get all data rows (not group headers)
            const rows = document.querySelectorAll('#results-table tr[data-row-number]');
            let visibleCount = 0;
            const visibleGroups = new Set();

            rows.forEach(row => {
                const desc = row.dataset.description || '';
                const account = row.dataset.account || '';
                const severity = row.dataset.severity || '';
                const source = row.dataset.source || '';
                const issueType = row.dataset.issueType || '';

                const matchDesc = !descFilter || desc.includes(descFilter);
                const matchAccount = !accountFilter || account.includes(accountFilter);
                const matchSeverity = !severityFilter || severity === severityFilter;
                const matchSource = !sourceFilter || source.includes(sourceFilter);
                const matchIssueType = !issueTypeFilter || issueType === issueTypeFilter;

                if (matchDesc && matchAccount && matchSeverity && matchSource && matchIssueType) {
                    row.style.display = '';
                    visibleCount++;
                    if (issueType) visibleGroups.add(issueType);
                } else {
                    row.style.display = 'none';
                }
            });

            // Show/hide group headers based on whether they have visible items
            document.querySelectorAll('.group-header').forEach(header => {
                const groupId = header.querySelector('[id^="group-icon-"]')?.id?.replace('group-icon-', '');
                if (groupId) {
                    if (issueTypeFilter && groupId !== issueTypeFilter) {
                        header.style.display = 'none';
                    } else if (visibleGroups.has(groupId) || (!descFilter && !accountFilter && !severityFilter && !sourceFilter && !issueTypeFilter)) {
                        header.style.display = '';
                    } else {
                        header.style.display = visibleGroups.has(groupId) ? '' : 'none';
                    }
                }
            });

            // Show/hide group contents based on filters
            document.querySelectorAll('.group-content').forEach(content => {
                const groupId = content.id?.replace('group-content-', '');
                if (groupId && issueTypeFilter && groupId !== issueTypeFilter) {
                    content.style.display = 'none';
                }
            });

            // Restore horizontal scroll position
            if (scrollWrapper) {
                scrollWrapper.scrollLeft = scrollLeft;
            }

            // Update filter count
            const countEl = document.getElementById('filter-count');
            if (countEl) {
                const total = rows.length;
                if (visibleCount < total) {
                    countEl.textContent = `Showing ${visibleCount} of ${total}`;
                } else {
                    countEl.textContent = '';
                }
            }

        }

        function clearFilters() {
            const descInput = document.getElementById('filter-description');
            const accountInput = document.getElementById('filter-account');
            const severitySelect = document.getElementById('filter-severity');
            const sourceSelect = document.getElementById('filter-source');
            const issueTypeSelect = document.getElementById('filter-issue-type');

            if (descInput) descInput.value = '';
            if (accountInput) accountInput.value = '';
            if (severitySelect) severitySelect.value = '';
            if (sourceSelect) sourceSelect.value = '';
            if (issueTypeSelect) issueTypeSelect.value = '';

            // Show all groups again
            document.querySelectorAll('.group-header, .group-content').forEach(el => {
                el.style.display = '';
            });

            applyFilters();
        }

        async function pushAllJournalsToXero() {
            if (!reviewResults || !reviewResults.flagged_items) {
                alert('No review results available');
                return;
            }

            // Check if account is a revenue/income account based on name only
            const isRevenueAccount = (accountCode, accountName) => {
                const name = (accountName || '').toLowerCase();
                // Only check by name - code ranges vary by organization
                if (name.includes('sales') || name.includes('income') || name.includes('revenue') ||
                    name.includes('fees earned') || name.includes('interest received') ||
                    name.includes('consulting revenue') || name.includes('service revenue')) {
                    return true;
                }
                return false;
            };

            // Map tax codes to Xero Australia TaxType values based on account type
            const mapTaxCode = (code, accountCode, accountName) => {
                const isRevenue = isRevenueAccount(accountCode, accountName);

                // For GST taxable items
                if (code === 'GST on Expenses' || code === 'GST on Income') {
                    return isRevenue ? 'OUTPUT' : 'INPUT';
                }
                // For GST Free items
                if (code === 'GST Free' || code === 'GST Free Expenses' || code === 'GST Free Income') {
                    return isRevenue ? 'EXEMPTOUTPUT' : 'EXEMPTEXPENSES';
                }
                // For BAS Excluded - works for both
                if (code === 'BAS Excluded' || code === 'NONE') {
                    return 'BASEXCLUDED';
                }
                // Input Taxed (typically for financial supplies)
                if (code === 'Input Taxed') {
                    return 'INPUTTAXED';
                }
                // Default to BAS Excluded (safe for both account types)
                return 'BASEXCLUDED';
            };

            // Collect all journal entries from flagged items
            const allEntries = [];
            let narrationParts = [];

            reviewResults.flagged_items.forEach((item, index) => {
                if (item.correcting_journal && item.correcting_journal.entries && item.correcting_journal.entries.length > 0) {
                    item.correcting_journal.entries.forEach(e => {
                        allEntries.push({
                            AccountCode: e.account_code,
                            Description: `[${index + 1}] ${e.description || e.account_name}`,
                            LineAmount: e.debit > 0 ? e.debit : -e.credit,
                            TaxType: mapTaxCode(e.tax_code, e.account_code, e.account_name)
                        });
                    });
                    narrationParts.push(`${index + 1}. ${item.description.substring(0, 30)}`);
                }
            });

            if (allEntries.length === 0) {
                alert('No correcting journals to push');
                return;
            }

            // Get the end date from the date picker or use current date
            const endDateInput = document.getElementById('end-date');
            const endDateRaw = endDateInput ? endDateInput.value : null;
            const journalDate = endDateRaw ? toISODate(endDateRaw) : new Date().toISOString().split('T')[0];

            // Format narration as "Sep-25 BAS Adjustments"
            const endDate = endDateRaw ? parseDateAU(endDateRaw) : new Date();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthYear = `${monthNames[endDate.getMonth()]}-${String(endDate.getFullYear()).slice(-2)}`;

            const journalData = {
                narration: `${monthYear} BAS Adjustments`,
                date: journalDate,
                entries: allEntries
            };

            // Disable button and show loading
            const btn = document.getElementById('push-all-btn');
            btn.disabled = true;
            btn.textContent = 'Pushing...';
            btn.style.background = '#999';

            try {
                const response = await fetch('/api/push-journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(journalData)
                });

                const result = await response.json();

                if (result.success) {
                    btn.textContent = '‚úì All Pushed to Xero';
                    btn.style.background = '#28a745';
                    const msg = result.journal_number
                        ? `Draft journal #${result.journal_number} created with ${allEntries.length} line items!`
                        : `Draft journal created with ${allEntries.length} line items!`;
                    alert(msg);
                } else {
                    btn.textContent = 'Push All Journals to Xero (Draft)';
                    btn.style.background = '#13B5EA';
                    btn.disabled = false;
                    alert('Failed to push journals: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                btn.textContent = 'Push All Journals to Xero (Draft)';
                btn.style.background = '#13B5EA';
                btn.disabled = false;
                alert('Error pushing journals: ' + error.message);
            }
        }

        // Toggle to show all transactions sorted by GST rate
        function showAllTransactions() {
            if (currentView === 'all') return;  // Already showing all
            currentView = 'all';

            // Update card active states
            document.getElementById('total-card').classList.add('active');
            document.getElementById('flagged-card').classList.remove('active');

            if (!allTransactionsData || allTransactionsData.length === 0) {
                document.getElementById('flagged-table-container').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>No transaction data available. Run a review first.</p>
                    </div>
                `;
                return;
            }

            // Custom sort order for GST rates
            const gstRateOrder = [
                'GST on Income',
                'GST Free Income',
                'GST on Capital',
                'GST on Expenses',
                'GST Free Expenses',
                'GST Free',
                'Input Taxed',
                'BAS Excluded',
                'Unknown'
            ];

            // Function to get sort priority (lower = higher priority)
            function getGstRatePriority(rateName) {
                const rate = (rateName || 'Unknown').trim();
                const index = gstRateOrder.findIndex(r => r.toLowerCase() === rate.toLowerCase());
                return index >= 0 ? index : gstRateOrder.length; // Unknown rates go at the end
            }

            // Group by GST rate first
            const groupedByRate = {};
            allTransactionsData.forEach(txn => {
                const rate = txn.gst_rate_name || 'Unknown';
                if (!groupedByRate[rate]) {
                    groupedByRate[rate] = [];
                }
                groupedByRate[rate].push(txn);
            });

            // Sort groups by custom order
            const sortedGroups = Object.entries(groupedByRate).sort((a, b) => {
                return getGstRatePriority(a[0]) - getGstRatePriority(b[0]);
            });

            // Build the table
            let tableHtml = `
                <div style="margin-bottom: 15px; padding: 15px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #13B5EA;">
                    <strong>All Transactions</strong> - Showing ${allTransactionsData.length} transactions reviewed by AI, grouped by GST Rate
                </div>
                <div style="overflow-x: auto; width: 100%;">
                <table class="flagged-table">
                    <thead>
                        <tr>
                            <th style="width: 75px;">Date</th>
                            <th style="width: 100px;">Account</th>
                            <th style="width: 100px;">Reference</th>
                            <th style="width: 180px;">Description</th>
                            <th style="width: 80px; text-align: right;">Gross</th>
                            <th style="width: 60px; text-align: right;">GST</th>
                            <th style="width: 80px; text-align: right;">Net</th>
                            <th style="width: 80px;">Source</th>
                            <th style="width: 60px;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Render grouped by GST rate (using custom sort order)
            sortedGroups.forEach(([rate, txns]) => {
                // Sort transactions by date (oldest first)
                txns.sort((a, b) => {
                    const dateA = new Date(a.date || '1900-01-01');
                    const dateB = new Date(b.date || '1900-01-01');
                    return dateA - dateB;
                });

                // Calculate totals for this group
                const totalGross = txns.reduce((sum, t) => sum + (parseFloat(t.gross) || 0), 0);
                const totalGst = txns.reduce((sum, t) => sum + (parseFloat(t.gst) || 0), 0);

                // Group header
                tableHtml += `
                    <tr style="background: #e8f4f8; cursor: pointer;" onclick="toggleAllTxnGroup('${escapeHtml(rate.replace(/'/g, "\\'"))}')">
                        <td colspan="9" style="padding: 12px 15px; border-bottom: 1px solid #dee2e6;">
                            <span id="all-txn-icon-${escapeHtml(rate)}" style="margin-right: 8px;">‚ñº</span>
                            <strong>${escapeHtml(rate)}</strong>
                            <span style="margin-left: 10px; background: #13B5EA; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">${txns.length}</span>
                        </td>
                    </tr>
                `;

                tableHtml += `<tbody id="all-txn-group-${escapeHtml(rate)}" class="all-txn-group">`;
                txns.forEach(txn => {
                    const isFlagged = txn.flagged || txn.is_flagged;
                    const statusBadge = isFlagged
                        ? '<span style="background: #dc3545; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">Flagged</span>'
                        : '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px;">OK</span>';

                    // Format amount with parentheses for negatives
                    const formatAmount = (val) => {
                        const num = parseFloat(val || 0);
                        if (num < 0) {
                            return `(${Math.abs(num).toLocaleString('en-AU', {minimumFractionDigits: 2})})`;
                        }
                        return num.toLocaleString('en-AU', {minimumFractionDigits: 2});
                    };

                    tableHtml += `
                        <tr style="${isFlagged ? 'background: #fff5f5;' : ''}">
                            <td>${formatDateAU(txn.date)}</td>
                            <td>${escapeHtml(txn.account || '')} <small style="color:#666;">(${escapeHtml(txn.account_code || '')})</small></td>
                            <td><small>${escapeHtml(txn.reference || '-')}</small></td>
                            <td>${escapeHtml(txn.description || '')}</td>
                            <td style="text-align:right;">${formatAmount(txn.gross)}</td>
                            <td style="text-align:right;">${formatAmount(txn.gst)}</td>
                            <td style="text-align:right;">${formatAmount(txn.net)}</td>
                            <td><small>${escapeHtml(txn.source || '-')}</small></td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });

                // Add total row for this GST rate group
                const totalNet = txns.reduce((sum, t) => sum + (parseFloat(t.net) || 0), 0);

                // Format total with parentheses for negatives
                const formatTotal = (val) => {
                    if (val < 0) {
                        return `(${Math.abs(val).toLocaleString('en-AU', {minimumFractionDigits: 2})})`;
                    }
                    return val.toLocaleString('en-AU', {minimumFractionDigits: 2});
                };

                tableHtml += `
                    <tr style="background: #f8f9fa; border-top: 2px solid #dee2e6; font-weight: 600;">
                        <td colspan="4" style="text-align: left; padding: 10px 12px;">Total ${escapeHtml(rate)}</td>
                        <td style="text-align: right; padding: 10px 12px;">${formatTotal(totalGross)}</td>
                        <td style="text-align: right; padding: 10px 12px;">${formatTotal(totalGst)}</td>
                        <td style="text-align: right; padding: 10px 12px;">${formatTotal(totalNet)}</td>
                        <td colspan="2"></td>
                    </tr>
                `;
                tableHtml += `</tbody>`;
            });

            tableHtml += '</tbody></table></div>';
            document.getElementById('flagged-table-container').innerHTML = tableHtml;

            // Hide the Push All button in this view
            document.getElementById('push-all-btn').style.display = 'none';
        }

        // Toggle group expand/collapse for all transactions view
        function toggleAllTxnGroup(rate) {
            const content = document.getElementById('all-txn-group-' + rate);
            const icon = document.getElementById('all-txn-icon-' + rate);
            if (content && icon) {
                if (content.style.display === 'none') {
                    content.style.display = 'table-row-group';
                    icon.textContent = '‚ñº';
                } else {
                    content.style.display = 'none';
                    icon.textContent = '‚ñ∂';
                }
            }
        }

        // Toggle to show flagged items (default view)
        function showFlaggedItems() {
            if (currentView === 'flagged') return;  // Already showing flagged
            currentView = 'flagged';

            // Update card active states
            document.getElementById('flagged-card').classList.add('active');
            document.getElementById('total-card').classList.remove('active');

            // Re-render the flagged items view
            if (reviewResults) {
                displayResults(reviewResults, isUploadMode);
            }
        }

        // Render flagged items table (extracted for reuse)
        function renderFlaggedItems(items) {
            const container = document.getElementById('flagged-table-container');
            if (!items || items.length === 0) {
                container.innerHTML = `
                    <div class="no-issues">
                        <div class="icon">‚úÖ</div>
                        <h3>No Issues Found</h3>
                        <p>All transactions appear to be correctly recorded.</p>
                    </div>
                `;
                return;
            }

            // Re-render using displayResults logic
            if (reviewResults) {
                displayResults(reviewResults, isUploadMode);
            }
        }
    </script>
</body>
</html>
