<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAS Review{% if tenant_name %} - {{ tenant_name }}{% endif %}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5em;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .tenant-name {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
        }
        .header a {
            color: white;
            text-decoration: none;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }
        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .form-group input {
            width: 100%;
            max-width: 200px;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        .form-group input:focus {
            border-color: #667eea;
            outline: none;
        }
        .form-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .btn {
            display: inline-block;
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
        }
        .progress-section {
            display: none;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
        .status-text {
            color: #666;
            font-size: 0.95em;
        }
        .results-section {
            display: none;
        }
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .summary-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .summary-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }
        .summary-card .label {
            color: #666;
            font-size: 0.9em;
        }
        .summary-card.flagged .number {
            color: #dc3545;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .severity-high {
            background: #ffcccc;
        }
        .severity-medium {
            background: #fff3cd;
        }
        .severity-low {
            background: #d4edda;
        }
        .severity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .severity-badge.high {
            background: #dc3545;
            color: white;
        }
        .severity-badge.medium {
            background: #ffc107;
            color: #333;
        }
        .severity-badge.low {
            background: #28a745;
            color: white;
        }
        .comment-cell {
            min-width: 250px;
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }
        .comment-cell ul {
            margin: 0;
            padding-left: 18px;
        }
        .comment-cell li {
            margin-bottom: 4px;
        }
        #flagged-table-container {
            overflow-x: auto;
            max-width: 100%;
            margin-bottom: 20px;
        }
        .flagged-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .flagged-table th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 1;
        }
        .flagged-table td {
            vertical-align: top;
            padding: 10px 8px;
        }
        .flagged-table small {
            color: #666;
        }
        .journal-cell {
            min-width: 120px;
            padding: 8px !important;
            position: relative;
        }
        .journal-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
        }
        .journal-btn:hover {
            background: #218838;
        }
        .journal-btn.review-btn {
            background: #6c757d;
        }
        .journal-btn.review-btn:hover {
            background: #5a6268;
        }
        .journal-popover {
            display: none;
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 1000;
            min-width: 350px;
            max-width: 450px;
        }
        .journal-popover.show {
            display: block;
        }
        .journal-popover-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .journal-popover-header h4 {
            margin: 0;
            font-size: 14px;
            color: #333;
        }
        .journal-popover-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
            padding: 0;
            line-height: 1;
        }
        .journal-popover-close:hover {
            color: #333;
        }
        .journal-table {
            width: 100%;
            font-size: 0.85em;
            border-collapse: collapse;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .journal-table th {
            background: #e9ecef;
            padding: 4px 6px;
            font-weight: 600;
            font-size: 0.85em;
            text-align: left;
        }
        .journal-table td {
            padding: 4px 6px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        .journal-table tr:last-child td {
            border-bottom: none;
        }
        .no-issues {
            text-align: center;
            padding: 40px;
            color: #28a745;
        }
        .no-issues .icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .download-section {
            margin-top: 20px;
            text-align: right;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        .upload-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        .upload-area p {
            color: #666;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä BAS Reviewer</h1>
        <div class="header-right">
            {% if logged_in %}
            <span class="tenant-name">{{ tenant_name }}</span>
            {% endif %}
            <a href="{{ url_for('dashboard') }}">Dashboard</a>
            <a href="{{ url_for('auth.logout') }}">Logout</a>
        </div>
    </div>

    <div class="container">
        {% if logged_in %}
        <!-- Xero Review Section - shown when connected to Xero -->
        <div class="card" id="xero-review-card">
            <h2>Review Transactions from Xero</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Select the date range to review transactions from {{ tenant_name }}.
            </p>
            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">Start Date</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="start-date" placeholder="dd/mm/yyyy" style="padding: 10px; border: 2px solid #e1e1e1; border-radius: 8px 0 0 8px; font-size: 1em; width: 120px;">
                        <button type="button" onclick="document.getElementById('start-date-picker').showPicker()" style="padding: 10px 12px; border: 2px solid #e1e1e1; border-left: none; border-radius: 0 8px 8px 0; background: #f8f9fa; cursor: pointer; font-size: 1em;">üìÖ</button>
                        <input type="date" id="start-date-picker" style="position: absolute; opacity: 0; pointer-events: none;" onchange="syncDateFromPicker('start-date', this.value)">
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">End Date</label>
                    <div style="display: flex; align-items: center;">
                        <input type="text" id="end-date" placeholder="dd/mm/yyyy" style="padding: 10px; border: 2px solid #e1e1e1; border-radius: 8px 0 0 8px; font-size: 1em; width: 120px;">
                        <button type="button" onclick="document.getElementById('end-date-picker').showPicker()" style="padding: 10px 12px; border: 2px solid #e1e1e1; border-left: none; border-radius: 0 8px 8px 0; background: #f8f9fa; cursor: pointer; font-size: 1em;">üìÖ</button>
                        <input type="date" id="end-date-picker" style="position: absolute; opacity: 0; pointer-events: none;" onchange="syncDateFromPicker('end-date', this.value)">
                    </div>
                </div>
            </div>

            <!-- Review Mode Selection -->
            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">Review Mode</label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #13B5EA; border-radius: 8px; background: white;">
                        <input type="radio" name="review-mode" value="quick" checked style="width: 18px; height: 18px;">
                        <div>
                            <div style="font-weight: 600; color: #333;">Quick Review</div>
                            <div style="font-size: 0.85em; color: #666;">Standard review of selected period</div>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 15px; border: 2px solid #764ba2; border-radius: 8px; background: white;">
                        <input type="radio" name="review-mode" value="deep" style="width: 18px; height: 18px;">
                        <div>
                            <div style="font-weight: 600; color: #333;">Deep Scan</div>
                            <div style="font-size: 0.85em; color: #666;">Learn patterns from 12 months history first</div>
                        </div>
                    </label>
                </div>
                <p id="deep-scan-note" style="display: none; margin-top: 10px; font-size: 0.9em; color: #764ba2;">
                    Deep scan will analyze 12 months of history to detect allocation patterns. This takes longer but reduces false positives.
                </p>
            </div>

            <button class="btn btn-primary" id="xero-review-btn" onclick="runXeroReview()" style="background: #13B5EA;">
                Start Review
            </button>
        </div>
        {% else %}
        <!-- File Upload Section - shown when NOT connected to Xero -->
        <div class="card" id="upload-card">
            <h2>Upload General Ledger Detail Report</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Export the "General Ledger Detail" report from Xero (Reports ‚Üí All Reports ‚Üí General Ledger Detail) as an Excel file, then upload it here.
            </p>
            <div class="upload-area" id="upload-area">
                <div class="upload-icon">üìÅ</div>
                <p>Drag and drop your Excel file here, or click to browse</p>
                <input type="file" id="file-input" accept=".xlsx,.xls" style="display: none;">
            </div>
            <div id="file-name" style="margin-top: 15px; color: #667eea; display: none;"></div>
            <button class="btn btn-primary" id="upload-btn" onclick="uploadFile()" style="margin-top: 20px;" disabled>
                Review Uploaded File
            </button>
        </div>
        {% endif %}

        <!-- Progress Section -->
        <div class="card progress-section" id="progress-section">
            <h2>Review Progress</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <p class="status-text" id="status-text">Connecting to Xero...</p>
        </div>

        <!-- Results Section -->
        <div class="card results-section" id="results-section">
            <h2>Review Results</h2>

            <div class="summary-cards">
                <div class="summary-card">
                    <div class="number" id="total-count">0</div>
                    <div class="label">Total Transactions</div>
                </div>
                <div class="summary-card flagged">
                    <div class="number" id="flagged-count">0</div>
                    <div class="label">Flagged Items</div>
                </div>
            </div>

            <div id="flagged-table-container">
                <!-- Table will be inserted here -->
            </div>

            <div class="download-section" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-success" id="download-btn" onclick="downloadReport()" style="display:none;">
                    Download Excel Report
                </button>
                <button class="btn" id="push-all-btn" onclick="pushAllJournalsToXero()" style="display:none; background:#13B5EA; color:white;">
                    Push All Journals to Xero (Draft)
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let reviewResults = null;  // Store results for download

        // XSS Protection - escape HTML entities in user-controlled data
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        // Helper function to format date as dd/mm/yyyy
        function formatDateAU(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Helper function to parse dd/mm/yyyy to Date object
        function parseDateAU(dateStr) {
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // JS months are 0-indexed
            const year = parseInt(parts[2], 10);
            return new Date(year, month, day);
        }

        // Helper function to convert dd/mm/yyyy to yyyy-mm-dd for API
        function toISODate(dateStr) {
            const date = parseDateAU(dateStr);
            if (!date) return null;
            return date.toISOString().split('T')[0];
        }

        // Sync date from native picker to text input (convert yyyy-mm-dd to dd/mm/yyyy)
        function syncDateFromPicker(textInputId, isoDate) {
            if (!isoDate) return;
            const parts = isoDate.split('-');
            if (parts.length !== 3) return;
            const formatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
            document.getElementById(textInputId).value = formatted;
        }

        // Set default dates for Xero review (PREVIOUS quarter)
        // Australian BAS quarters: Jul-Sep, Oct-Dec, Jan-Mar, Apr-Jun
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        if (startDateInput && endDateInput) {
            const today = new Date();
            const month = today.getMonth(); // 0-11
            const year = today.getFullYear();

            // Determine current quarter and calculate previous quarter
            // Q1: Jul-Sep (months 6,7,8), Q2: Oct-Dec (9,10,11), Q3: Jan-Mar (0,1,2), Q4: Apr-Jun (3,4,5)
            let prevQStart, prevQEnd;

            if (month >= 0 && month <= 2) {
                // Current is Jan-Mar, previous is Oct-Dec of previous year
                prevQStart = new Date(year - 1, 9, 1);  // Oct 1
                prevQEnd = new Date(year - 1, 11, 31); // Dec 31
            } else if (month >= 3 && month <= 5) {
                // Current is Apr-Jun, previous is Jan-Mar
                prevQStart = new Date(year, 0, 1);     // Jan 1
                prevQEnd = new Date(year, 2, 31);      // Mar 31
            } else if (month >= 6 && month <= 8) {
                // Current is Jul-Sep, previous is Apr-Jun
                prevQStart = new Date(year, 3, 1);     // Apr 1
                prevQEnd = new Date(year, 5, 30);      // Jun 30
            } else {
                // Current is Oct-Dec, previous is Jul-Sep
                prevQStart = new Date(year, 6, 1);     // Jul 1
                prevQEnd = new Date(year, 8, 30);      // Sep 30
            }

            startDateInput.value = formatDateAU(prevQStart);
            endDateInput.value = formatDateAU(prevQEnd);
        }

        // Review mode toggle
        document.querySelectorAll('input[name="review-mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const deepScanNote = document.getElementById('deep-scan-note');
                const reviewBtn = document.getElementById('xero-review-btn');
                if (this.value === 'deep') {
                    deepScanNote.style.display = 'block';
                    reviewBtn.textContent = 'Start Deep Scan';
                    reviewBtn.style.background = '#764ba2';
                } else {
                    deepScanNote.style.display = 'none';
                    reviewBtn.textContent = 'Start Review';
                    reviewBtn.style.background = '#13B5EA';
                }
            });
        });

        // Xero review function
        async function runXeroReview() {
            const startDateRaw = document.getElementById('start-date').value;
            const endDateRaw = document.getElementById('end-date').value;
            const reviewMode = document.querySelector('input[name="review-mode"]:checked').value;

            if (!startDateRaw || !endDateRaw) {
                alert('Please enter both start and end dates');
                return;
            }

            // Convert dd/mm/yyyy to yyyy-mm-dd for API
            const startDate = toISODate(startDateRaw);
            const endDate = toISODate(endDateRaw);

            if (!startDate || !endDate) {
                alert('Please enter dates in dd/mm/yyyy format');
                return;
            }

            // Show progress
            document.getElementById('xero-review-btn').disabled = true;
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            let progress = 0;
            const progressFill = document.getElementById('progress-fill');
            const statusText = document.getElementById('status-text');

            if (reviewMode === 'deep') {
                statusText.textContent = 'Scanning 12 months of history to learn patterns...';
            } else {
                statusText.textContent = 'Fetching transactions from Xero...';
            }

            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * (reviewMode === 'deep' ? 3 : 10);
                    progressFill.style.width = Math.min(progress, 90) + '%';
                }
            }, 500);

            try {
                const response = await fetch('/api/run-review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        review_mode: reviewMode
                    })
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                const data = await response.json();

                if (data.error) {
                    let errorMsg = 'Error: ' + data.error;
                    if (data.debug && Array.isArray(data.debug)) {
                        errorMsg += '\n\nDebug Info:\n' + data.debug.join('\n');
                    }
                    statusText.innerHTML = '<pre style="text-align: left; white-space: pre-wrap; font-size: 12px;">' + escapeHtml(errorMsg) + '</pre>';
                    document.getElementById('xero-review-btn').disabled = false;
                    return;
                }

                reviewResults = data;
                displayResults(data);
                document.getElementById('xero-review-btn').disabled = false;

            } catch (error) {
                clearInterval(progressInterval);
                statusText.textContent = 'Error: ' + error.message;
                document.getElementById('xero-review-btn').disabled = false;
            }
        }

        // File upload handling - only if upload elements exist
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const fileNameDiv = document.getElementById('file-name');
        const uploadBtn = document.getElementById('upload-btn');

        if (uploadArea && fileInput) {
            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('Please select an Excel file (.xlsx or .xls)');
                return;
            }
            selectedFile = file;
            fileNameDiv.textContent = 'Selected: ' + file.name;
            fileNameDiv.style.display = 'block';
            uploadBtn.disabled = false;
        }

        async function uploadFile() {
            if (!selectedFile) {
                alert('Please select a file first');
                return;
            }

            // Show progress
            uploadBtn.disabled = true;
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('results-section').style.display = 'none';

            let progress = 0;
            const progressFill = document.getElementById('progress-fill');
            const statusText = document.getElementById('status-text');

            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    progressFill.style.width = Math.min(progress, 90) + '%';
                }
            }, 300);

            statusText.textContent = 'Uploading and parsing file...';

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const response = await fetch('/api/upload-review', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';
                statusText.textContent = 'Review complete!';

                const data = await response.json();

                if (response.ok) {
                    displayResults(data, true);  // true = upload mode (no Push to Xero)
                } else {
                    let errorMsg = data.error || 'Review failed (no error details)';
                    if (data.hint) errorMsg += '\n\nHint: ' + data.hint;
                    if (data.first_rows) errorMsg += '\n\nFirst rows:\n' + data.first_rows;
                    if (data.trace) {
                        console.error('Server Error Trace:', data.trace);
                        errorMsg += '\n\n(Check browser console for details)';
                    }
                    console.error('Review error response:', data);
                    alert('Error: ' + errorMsg);
                    document.getElementById('progress-section').style.display = 'none';
                }
            } catch (error) {
                clearInterval(progressInterval);
                document.getElementById('progress-section').style.display = 'none';
                alert('Error: ' + error.message);
            }

            uploadBtn.disabled = false;
        }

        // Format date to dd/mm/yyyy (accepts Date object or yyyy-mm-dd string)
        function formatDateAU(dateInput) {
            if (!dateInput) return '';

            // Handle Date object
            if (dateInput instanceof Date) {
                const day = String(dateInput.getDate()).padStart(2, '0');
                const month = String(dateInput.getMonth() + 1).padStart(2, '0');
                const year = dateInput.getFullYear();
                return `${day}/${month}/${year}`;
            }

            // Handle yyyy-mm-dd string
            if (typeof dateInput === 'string') {
                const parts = dateInput.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
            }
            return String(dateInput);
        }

        // Store flagged items globally for filtering
        let allFlaggedItems = [];
        let isUploadMode = false;  // Track if results are from file upload

        function displayResults(data, uploadMode = false) {
            isUploadMode = uploadMode;  // Store for later use
            // Store results for download
            reviewResults = data;

            // Hide progress, show results
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';

            // Update counts
            document.getElementById('total-count').textContent = data.total_transactions || 0;
            document.getElementById('flagged-count').textContent = data.flagged_count || 0;

            // Scroll to results
            document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });

            const container = document.getElementById('flagged-table-container');

            const flaggedCount = data.flagged_count || 0;
            allFlaggedItems = data.flagged_items || [];
            const flaggedItems = allFlaggedItems;

            if (flaggedCount === 0 || flaggedItems.length === 0) {
                container.innerHTML = `
                    <div class="no-issues">
                        <div class="icon">‚úÖ</div>
                        <h3>No Issues Found</h3>
                        <p>All ${data.total_transactions || 0} transactions appear to be correctly recorded.</p>
                    </div>
                `;
                document.getElementById('download-btn').style.display = 'none';
            } else {
                let tableHtml = `
                    <div class="filter-controls" style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <label style="font-weight: 500; font-size: 14px;">Filter:</label>
                        </div>
                        <input type="text" id="filter-description" placeholder="Description..." oninput="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 150px;">
                        <input type="text" id="filter-account" placeholder="Account..." oninput="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 120px;">
                        <select id="filter-severity" onchange="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">All Severities</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <select id="filter-source" onchange="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="">All Sources</option>
                            <option value="ACCPAY">ACCPAY (Bills)</option>
                            <option value="Bill">Bill</option>
                            <option value="SPEND">Bank Spend</option>
                            <option value="RECEIVE">Bank Receive</option>
                            <option value="MANJOURNAL">Manual Journal</option>
                        </select>
                        <button onclick="clearFilters()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Clear</button>
                        <span id="filter-count" style="margin-left: auto; font-size: 14px; color: #666;"></span>
                    </div>
                    <div id="table-scroll-wrapper" style="overflow-x: auto; width: 100%;">
                    <table class="flagged-table" id="results-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;">Row</th>
                                <th style="width: 70px;">Severity</th>
                                <th style="width: 80px;">Date</th>
                                <th style="width: 120px;">Account</th>
                                <th style="width: 150px;">Description</th>
                                <th style="width: 70px;">Gross</th>
                                <th style="width: 60px;">GST</th>
                                <th style="width: 70px;">Net</th>
                                <th style="width: 70px;">Source</th>
                                <th>Comments / Suggested Journal</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody">
                `;

                flaggedItems.forEach(item => {
                    // Escape all user-controlled data to prevent XSS
                    const desc = escapeHtml(item.description);
                    const comments = escapeHtml(item.comments || '');
                    // Split comments by pipe and format as list (already escaped)
                    const commentParts = comments.split(' | ').filter(c => c.trim());
                    const formattedComments = commentParts.length > 1
                        ? '<ul style="margin:0; padding-left:18px;">' + commentParts.map(c => '<li>' + c + '</li>').join('') + '</ul>'
                        : comments;

                    // Format correcting journal with escaped data
                    let journalHtml = '';
                    if (item.correcting_journal && item.correcting_journal.entries && item.correcting_journal.entries.length > 0) {
                        // Build the journal table HTML inline
                        journalHtml = '<table class="journal-table"><thead><tr><th>Acc</th><th>DR</th><th>CR</th><th>Tax</th></tr></thead><tbody>';
                        item.correcting_journal.entries.forEach(entry => {
                            const dr = entry.debit > 0 ? '$' + parseFloat(entry.debit).toLocaleString('en-AU', {minimumFractionDigits: 2}) : '';
                            const cr = entry.credit > 0 ? '$' + parseFloat(entry.credit).toLocaleString('en-AU', {minimumFractionDigits: 2}) : '';
                            journalHtml += '<tr>';
                            journalHtml += '<td><strong>' + escapeHtml(entry.account_code || '') + '</strong><br><small>' + escapeHtml(entry.account_name || '') + '</small></td>';
                            journalHtml += '<td style="text-align:right;">' + dr + '</td>';
                            journalHtml += '<td style="text-align:right;">' + cr + '</td>';
                            journalHtml += '<td><small>' + escapeHtml(entry.tax_code || '') + '</small></td>';
                            journalHtml += '</tr>';
                        });
                        journalHtml += '</tbody></table>';
                        // Add Push to Xero button - store journal data as base64 encoded JSON
                        // Check if account is a revenue/income account based on name only
                        const isRevenueAcct = (accountCode, accountName) => {
                            const name = (accountName || '').toLowerCase();
                            // Only check by name - code ranges vary by organization
                            if (name.includes('sales') || name.includes('income') || name.includes('revenue') ||
                                name.includes('fees earned') || name.includes('interest received') ||
                                name.includes('consulting revenue') || name.includes('service revenue')) {
                                return true;
                            }
                            return false;
                        };
                        // Map tax codes to Xero Australia TaxType values based on account type
                        const mapTaxCode = (taxCode, accountCode, accountName) => {
                            const isRevenue = isRevenueAcct(accountCode, accountName);
                            if (taxCode === 'GST on Expenses' || taxCode === 'GST on Income') {
                                return isRevenue ? 'OUTPUT' : 'INPUT';
                            }
                            if (taxCode === 'GST Free' || taxCode === 'GST Free Expenses' || taxCode === 'GST Free Income') {
                                return isRevenue ? 'EXEMPTOUTPUT' : 'EXEMPTEXPENSES';
                            }
                            if (taxCode === 'BAS Excluded' || taxCode === 'NONE') return 'BASEXCLUDED';
                            if (taxCode === 'Input Taxed') return 'INPUTTAXED';
                            return 'BASEXCLUDED';
                        };
                        const journalData = {
                            narration: item.correcting_journal.narration || `BAS Correction: ${item.description}`,
                            date: item.date,
                            entries: item.correcting_journal.entries.map(e => ({
                                AccountCode: e.account_code,
                                Description: e.description || e.account_name,
                                LineAmount: e.debit > 0 ? e.debit : -e.credit,
                                TaxType: mapTaxCode(e.tax_code, e.account_code, e.account_name)
                            }))
                        };
                        const journalDataStr = btoa(JSON.stringify(journalData));
                        // Only show Push to Xero button if NOT in upload mode (Xero connection required)
                        if (!uploadMode) {
                            journalHtml += `<button class="btn-push-xero" onclick="pushJournalToXero('${journalDataStr}', this)" style="margin-left:5px; padding:6px 10px; font-size:12px; background:#13B5EA; color:white; border:none; border-radius:4px; cursor:pointer;">Push to Xero</button>`;
                        }
                    } else {
                        // Provide helpful review guidance based on issue type
                        let reviewMsg = 'Review';
                        if (item.account_coding_suspicious || (item.comments && item.comments.toLowerCase().includes('account'))) {
                            reviewMsg = 'Review account';
                        } else if (item.missing_gst_error || item.input_taxed_gst_error || (item.comments && (item.comments.toLowerCase().includes('gst') || item.comments.toLowerCase().includes('tax')))) {
                            reviewMsg = 'Review GST';
                        } else if (item.comments && item.comments.toLowerCase().includes('capitaliz')) {
                            reviewMsg = 'Review asset';
                        } else {
                            reviewMsg = 'Review';
                        }
                        journalHtml = `<em style="color:#666;">${reviewMsg}</em>`;
                    }

                    // Sanitize severity to only allow known values
                    const safeSeverity = ['low', 'medium', 'high'].includes(item.severity) ? item.severity : 'medium';

                    // Combine comments and journal into one cell
                    let combinedHtml = '';
                    if (formattedComments) {
                        combinedHtml += '<div style="margin-bottom: 8px;">' + formattedComments + '</div>';
                    }
                    if (journalHtml) {
                        combinedHtml += '<div style="background: #f9f9f9; padding: 8px; border-radius: 4px;">' + journalHtml + '</div>';
                    }

                    tableHtml += `
                        <tr class="severity-${safeSeverity}"
                            data-description="${escapeHtml(item.description || '').toLowerCase()}"
                            data-account="${escapeHtml(item.account || '').toLowerCase()} ${escapeHtml(item.account_code || '').toLowerCase()}"
                            data-severity="${safeSeverity}"
                            data-source="${escapeHtml(item.source || '').toLowerCase()}">
                            <td>${escapeHtml(item.row_number)}</td>
                            <td><span class="severity-badge ${safeSeverity}">${safeSeverity.toUpperCase()}</span></td>
                            <td>${formatDateAU(item.date)}</td>
                            <td><strong>${escapeHtml(item.account_code)}</strong><br><small>${escapeHtml(item.account)}</small></td>
                            <td>${desc}</td>
                            <td style="text-align:right;">$${parseFloat(item.gross || 0).toLocaleString('en-AU', {minimumFractionDigits: 2})}</td>
                            <td style="text-align:right;">$${parseFloat(item.gst || 0).toLocaleString('en-AU', {minimumFractionDigits: 2})}</td>
                            <td style="text-align:right;">$${parseFloat(item.net || 0).toLocaleString('en-AU', {minimumFractionDigits: 2})}</td>
                            <td><small>${escapeHtml(item.source || '-')}</small>${item.xero_url ? `<br><a href="${escapeHtml(item.xero_url)}" target="_blank" style="font-size: 11px; color: #13B5EA;">View in Xero</a>` : ''}</td>
                            <td class="comment-cell">${combinedHtml}</td>
                        </tr>
                    `;
                });

                tableHtml += '</tbody></table></div>';
                container.innerHTML = tableHtml;
                document.getElementById('download-btn').style.display = 'inline-block';
                // Show Push All button only if there are flagged items with journals AND not in upload mode
                const hasJournals = data.flagged_items && data.flagged_items.some(item =>
                    item.correcting_journal && item.correcting_journal.entries && item.correcting_journal.entries.length > 0
                );
                if (hasJournals && !uploadMode) {
                    document.getElementById('push-all-btn').style.display = 'inline-block';
                } else {
                    document.getElementById('push-all-btn').style.display = 'none';
                }
            }

            // Always show download button (even if no issues, user might want the report)
            document.getElementById('download-btn').style.display = 'inline-block';
        }

        async function downloadReport() {
            if (!reviewResults) {
                alert('No review results to download');
                return;
            }

            try {
                const response = await fetch('/download-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(reviewResults)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `BAS_Review_${new Date().toISOString().slice(0,10)}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const error = await response.json();
                    alert('Download failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Download error: ' + error.message);
            }
        }

        async function pushJournalToXero(journalDataBase64, buttonElement) {
            try {
                // Decode the journal data
                const journalData = JSON.parse(atob(journalDataBase64));

                // Disable the button and show loading state
                buttonElement.disabled = true;
                buttonElement.textContent = 'Pushing...';
                buttonElement.style.background = '#999';

                const response = await fetch('/api/push-journal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(journalData)
                });

                const result = await response.json();

                if (result.success) {
                    buttonElement.textContent = '‚úì Pushed to Xero';
                    buttonElement.style.background = '#28a745';
                    buttonElement.style.cursor = 'default';
                    // Show success message
                    const msg = result.journal_number
                        ? `Draft journal #${result.journal_number} created in Xero!`
                        : 'Draft journal created in Xero!';
                    alert(msg);
                } else {
                    buttonElement.textContent = 'Push to Xero (Draft)';
                    buttonElement.style.background = '#13B5EA';
                    buttonElement.disabled = false;
                    alert('Failed to push journal: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                buttonElement.textContent = 'Push to Xero (Draft)';
                buttonElement.style.background = '#13B5EA';
                buttonElement.disabled = false;
                alert('Error pushing journal: ' + error.message);
            }
        }

        // Filter functions
        function applyFilters() {
            const descFilter = (document.getElementById('filter-description')?.value || '').toLowerCase();
            const accountFilter = (document.getElementById('filter-account')?.value || '').toLowerCase();
            const severityFilter = document.getElementById('filter-severity')?.value || '';
            const sourceFilter = (document.getElementById('filter-source')?.value || '').toLowerCase();

            // Preserve horizontal scroll position of the table scroll wrapper
            const scrollWrapper = document.getElementById('table-scroll-wrapper');
            const scrollLeft = scrollWrapper ? scrollWrapper.scrollLeft : 0;

            const rows = document.querySelectorAll('#results-tbody > tr');
            let visibleCount = 0;

            rows.forEach(row => {
                const desc = row.dataset.description || '';
                const account = row.dataset.account || '';
                const severity = row.dataset.severity || '';
                const source = row.dataset.source || '';

                const matchDesc = !descFilter || desc.includes(descFilter);
                const matchAccount = !accountFilter || account.includes(accountFilter);
                const matchSeverity = !severityFilter || severity === severityFilter;
                const matchSource = !sourceFilter || source.includes(sourceFilter);

                if (matchDesc && matchAccount && matchSeverity && matchSource) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // Restore horizontal scroll position
            if (scrollWrapper) {
                scrollWrapper.scrollLeft = scrollLeft;
            }

            // Update filter count
            const countEl = document.getElementById('filter-count');
            if (countEl) {
                const total = rows.length;
                if (visibleCount < total) {
                    countEl.textContent = `Showing ${visibleCount} of ${total}`;
                } else {
                    countEl.textContent = '';
                }
            }

        }

        function clearFilters() {
            const descInput = document.getElementById('filter-description');
            const accountInput = document.getElementById('filter-account');
            const severitySelect = document.getElementById('filter-severity');
            const sourceSelect = document.getElementById('filter-source');

            if (descInput) descInput.value = '';
            if (accountInput) accountInput.value = '';
            if (severitySelect) severitySelect.value = '';
            if (sourceSelect) sourceSelect.value = '';

            applyFilters();
        }

        async function pushAllJournalsToXero() {
            if (!reviewResults || !reviewResults.flagged_items) {
                alert('No review results available');
                return;
            }

            // Check if account is a revenue/income account based on name only
            const isRevenueAccount = (accountCode, accountName) => {
                const name = (accountName || '').toLowerCase();
                // Only check by name - code ranges vary by organization
                if (name.includes('sales') || name.includes('income') || name.includes('revenue') ||
                    name.includes('fees earned') || name.includes('interest received') ||
                    name.includes('consulting revenue') || name.includes('service revenue')) {
                    return true;
                }
                return false;
            };

            // Map tax codes to Xero Australia TaxType values based on account type
            const mapTaxCode = (code, accountCode, accountName) => {
                const isRevenue = isRevenueAccount(accountCode, accountName);

                // For GST taxable items
                if (code === 'GST on Expenses' || code === 'GST on Income') {
                    return isRevenue ? 'OUTPUT' : 'INPUT';
                }
                // For GST Free items
                if (code === 'GST Free' || code === 'GST Free Expenses' || code === 'GST Free Income') {
                    return isRevenue ? 'EXEMPTOUTPUT' : 'EXEMPTEXPENSES';
                }
                // For BAS Excluded - works for both
                if (code === 'BAS Excluded' || code === 'NONE') {
                    return 'BASEXCLUDED';
                }
                // Input Taxed (typically for financial supplies)
                if (code === 'Input Taxed') {
                    return 'INPUTTAXED';
                }
                // Default to BAS Excluded (safe for both account types)
                return 'BASEXCLUDED';
            };

            // Collect all journal entries from flagged items
            const allEntries = [];
            let narrationParts = [];

            reviewResults.flagged_items.forEach((item, index) => {
                if (item.correcting_journal && item.correcting_journal.entries && item.correcting_journal.entries.length > 0) {
                    item.correcting_journal.entries.forEach(e => {
                        allEntries.push({
                            AccountCode: e.account_code,
                            Description: `[${index + 1}] ${e.description || e.account_name}`,
                            LineAmount: e.debit > 0 ? e.debit : -e.credit,
                            TaxType: mapTaxCode(e.tax_code, e.account_code, e.account_name)
                        });
                    });
                    narrationParts.push(`${index + 1}. ${item.description.substring(0, 30)}`);
                }
            });

            if (allEntries.length === 0) {
                alert('No correcting journals to push');
                return;
            }

            // Get the end date from the date picker or use current date
            const endDateInput = document.getElementById('end-date');
            const endDateRaw = endDateInput ? endDateInput.value : null;
            const journalDate = endDateRaw ? toISODate(endDateRaw) : new Date().toISOString().split('T')[0];

            // Format narration as "Sep-25 BAS Adjustments"
            const endDate = endDateRaw ? parseDateAU(endDateRaw) : new Date();
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthYear = `${monthNames[endDate.getMonth()]}-${String(endDate.getFullYear()).slice(-2)}`;

            const journalData = {
                narration: `${monthYear} BAS Adjustments`,
                date: journalDate,
                entries: allEntries
            };

            // Disable button and show loading
            const btn = document.getElementById('push-all-btn');
            btn.disabled = true;
            btn.textContent = 'Pushing...';
            btn.style.background = '#999';

            try {
                const response = await fetch('/api/push-journal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(journalData)
                });

                const result = await response.json();

                if (result.success) {
                    btn.textContent = '‚úì All Pushed to Xero';
                    btn.style.background = '#28a745';
                    const msg = result.journal_number
                        ? `Draft journal #${result.journal_number} created with ${allEntries.length} line items!`
                        : `Draft journal created with ${allEntries.length} line items!`;
                    alert(msg);
                } else {
                    btn.textContent = 'Push All Journals to Xero (Draft)';
                    btn.style.background = '#13B5EA';
                    btn.disabled = false;
                    alert('Failed to push journals: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                btn.textContent = 'Push All Journals to Xero (Draft)';
                btn.style.background = '#13B5EA';
                btn.disabled = false;
                alert('Error pushing journals: ' + error.message);
            }
        }
    </script>
</body>
</html>
